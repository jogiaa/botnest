rules:
  use_tools_only: &use_tools_only |
    STRICT RULE:
    - Only use registered tools.
    - For food search: ONLY call get_food_carbs_tool.
    - For carb calculations: ONLY call carb_calculator_tool.
    - Never use your own knowledge.
    - Never hallucinate carb values or weights.
    - Never do math yourself.

  normalize_query: &normalize_query |
    When calling get_food_carbs_tool, pass ONLY:
      { "food_name": "<food item name>" }
    - Remove serving sizes, weights, units, descriptors (handled later).
    - Example:
        Query: "Carbs in 1lb green beans?"
        ✅ { "food_name": "green beans" }
        ❌ { "food_name": "green beans", "size": "1 lb" }

  unit_conversion: &unit_conversion |
    Always convert weights to grams before calculations:
    - 1 kg = 1000 g
    - 1 lb = 453.59 g
    - 1 oz = 28.35 g
    Round to 2 decimals.

  serving_size_estimation: &serving_size_estimation |
    When query mentions serving size (e.g., "small", "medium", "large"):
    - Use a food-specific weight range (e.g., medium apple = 150–200g).
    - Always calculate the average of the range: (min+max)/2.
    - Use this average in grams as the weight.
    - Never invent serving sizes that are not commonly associated with that food.

  use_carbs_math_tool_only: &use_carbs_math_tool_only |
    STRICT RULE:
    - Never calculate yourself.
    - Call carb_calculator_tool ONLY with:
        { "per_100g": <number>, "grams": <number> }
    - Extract the numeric per_100g value directly from get_food_carbs_tool.
    - Do not include food_name, objects, or nested JSON.

workflow:
  - step: lookup_food_carbs
    description: Always call get_food_carbs_tool FIRST to retrieve per_100g carbs.
    call: get_food_carbs_tool
    rules:
      - *normalize_query
      - *use_tools_only

  - step: determine_weight
    description: Determine weight in grams.
    rules:
      - *unit_conversion
      - *serving_size_estimation
      - If explicit weight provided → use it directly (after conversion).
      - If serving size provided → apply serving_size_estimation.
      - If neither provided → only use per_100g, no calculation.

  - step: perform_calculation
    description: Only after lookup_food_carbs and determine_weight are done, call carb_calculator_tool.
    call: carb_calculator_tool
    rules:
      - *use_carbs_math_tool_only
    inputs:
      - from: lookup_food_carbs.per_100g
        to: per_100g
      - from: determine_weight.grams
        to: grams