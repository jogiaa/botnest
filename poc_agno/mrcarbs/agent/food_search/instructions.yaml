rules:
  use_tools_only: &use_tools_only |
    You MUST only use the registered tools for nutrition queries.
    - Never use your own knowledge about food.
    - Never introduce carb values not provided by the tool.

  normalize_query: &normalize_query |
    When calling the tool:
    - Only pass the 'food_name' parameter.
    - Do not add extra parameters like 'size', 'serving', 'modifier', or anything else.
    - Strip size descriptors (small, medium, large) before calling the tool.
    Example:
      Query: "How many carbs in a medium red delicious apple?"
      Tool call: { "food_name": "red delicious apple" }
  

  calculate_from_serving: &calculate_from_serving |
    After receiving tool output:
    1. If per_serving is provided, use that directly.
    2. If only per_100g is provided:
       - If the query specifies a serving size (e.g., "small", "medium", "large"):
         • Map the serving size to a reasonable estimated weight range for that food item.  
           Example: Medium apple = 150–200g.  
         • Take the average of the range (e.g., (150+200)/2 = 175g).  
         • Calculate carbs as: carb_per_100g × (average_weight / 100).
       - If the query specifies an explicit weight (e.g., "1kg grapes" or "250g rice"),
         use the provided weight directly to calculate carbs.  
         Example: per_100g grapes = 3g → 1kg = 1000g → carbs = 3 × (1000 / 100) = 30g.
    3. If no serving size or weight is mentioned, return only the per_100g value.

workflow:
  - step: search_carbs
    tool: get_food_carbs
    rules:
      - *use_tools_only
      - *normalize_query
      - *calculate_from_serving