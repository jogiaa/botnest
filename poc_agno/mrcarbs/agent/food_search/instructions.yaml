rules:
  use_tools_only: &use_tools_only |
    You MUST only use the registered tools for nutrition queries.
    - Never use your own knowledge about food.
    - Never introduce carb values not provided by the tool.

  normalize_query: &normalize_query |
    STRICT RULE: When calling the tool you must pass ONLY:
      { "food_name": "<food item name>" }
    - Do NOT include any other parameters (such as size, serving, weight, unit, modifier).
    - Remove descriptors like "1lb", "1 pound", "medium", "small", "large", "cup", "slice" before calling the tool.
    - These descriptors will be handled later during calculation, not in the tool call.
    - Example:
        Query: "How many carbs in a 1lb of green beans?"
        ✅ Tool call: { "food_name": "green beans" }
        ❌ Tool call: { "food_name": "green beans", "size": "1 pound" }

  unit_conversion: &unit_conversion |
    When a query includes weight in non-gram units, always convert to grams:
    - 1 kilogram (kg) = 1000 grams
    - 1 pound (lb) = 453.59 grams
    - 1 ounce (oz) = 28.35 grams
    - Round to 2 decimal places when needed
    Use these conversions before calculating carbs.

  calculate_from_serving:
    priority_1_per_serving: &priority_1_per_serving |
      If the tool provides a per_serving value:
      - Use that directly.
      - Do not attempt to re-calculate from per_100g.

    priority_2_explicit_weight: &priority_2_explicit_weight |
      If the query includes an explicit weight (grams, kilograms, pounds, ounces):
      - Always prioritize this over serving-size estimation.
      - Apply *unit_conversion* if needed.
      - Calculate carbs as: carb_per_100g × (weight_in_grams / 100).
      Example: per_100g grapes = 3g → 1kg = 1000g → carbs = 3 × (1000 / 100) = 30g.

    priority_3_serving_size: &priority_3_serving_size |
      If the query specifies a serving size (e.g., "small", "medium", "large"):
      - Map the serving size to a reasonable estimated weight range for that food item.
        Example: Medium apple = 150–200g.
      - Take the average of the range (e.g., (150+200)/2 = 175g).
      - Calculate carbs as: carb_per_100g × (average_weight / 100).

    fallback_per_100g: &fallback_per_100g |
      If no serving size or weight is mentioned:
      - Return only the per_100g value from the tool.

workflow:
  - step: normalize_and_search
    rules:
      - *use_tools_only
      - *normalize_query
      - *unit_conversion
  - step: calculate_carbs
    rules:
      - *priority_1_per_serving
      - *priority_2_explicit_weight
      - *priority_3_serving_size
      - *fallback_per_100g
